@model WirtualnaUczelnia.Models.Transition

@{
    ViewData["Title"] = "Dodaj przejœcie";
}

<h1 tabindex="0">Dodaj nowe przejœcie (Strza³kê)</h1>
<hr />

<div class="row">
    <!-- Lewa kolumna: Formularz -->
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <div class="form-group mb-3">
                <label class="control-label fw-bold">1. Sk¹d wychodzimy?</label>
                <select asp-for="SourceLocationId" class="form-select" asp-items="ViewBag.SourceLocationId" id="sourceSelect">
                    <option value="">-- Wybierz --</option>
                </select>
            </div>

            <div class="form-group mb-3">
                <label class="control-label fw-bold">2. Dok¹d idziemy?</label>
                <select asp-for="TargetLocationId" class="form-select" asp-items="ViewBag.TargetLocationId"></select>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Direction" class="control-label fw-bold">3. Rodzaj strza³ki</label>
                <select asp-for="Direction" class="form-select" asp-items="Html.GetEnumSelectList<WirtualnaUczelnia.Models.Direction>()"></select>
            </div>

            <!-- Koszt przejœcia -->
            <div class="form-group mb-3">
                <label asp-for="Cost" class="control-label fw-bold">
                    <i class="bi bi-speedometer2 text-info" aria-hidden="true"></i> Koszt przejœcia
                </label>
                <input asp-for="Cost" type="number" class="form-control" min="1" max="1000" value="10" aria-describedby="costHelp" />
                <small id="costHelp" class="form-text text-muted">
                    Umowna wartoœæ (np. w sekundach lub metrach). Im wy¿szy koszt, tym mniej preferowane przejœcie.
                    <br><strong>Przyk³ady:</strong> Krótki korytarz = 5, Normalny = 10, D³ugi korytarz = 20, Schody = 15-25, Winda = 30
                </small>
                <span asp-validation-for="Cost" class="text-danger" role="alert"></span>
            </div>

            <!-- Checkbox dostêpnoœci dla wózków -->
            <div class="form-check mb-3 p-3 bg-light border rounded">
                <input class="form-check-input ms-1" asp-for="IsWheelchairAccessible" id="accessibilityCheck" checked style="transform: scale(1.3);" />
                <label class="form-check-label fw-bold ms-2" for="accessibilityCheck">
                    <i class="bi bi-person-wheelchair text-primary" aria-hidden="true"></i> Dostêpne dla wózków
                </label>
                <div class="form-text ms-1 mt-1">Zostaw zaznaczone, jeœli jest p³asko lub jest winda. Odznacz, jeœli to schody.</div>
            </div>

            <!-- Checkbox ukrycia -->
            <div class="form-check mb-3 p-3 bg-light border rounded">
                <input class="form-check-input ms-1" asp-for="IsHidden" id="isHiddenCheck" style="transform: scale(1.3);" />
                <label class="form-check-label fw-bold ms-2" for="isHiddenCheck">
                    <i class="bi bi-eye-slash text-secondary" aria-hidden="true"></i> Ukryte
                </label>
                <div class="form-text ms-1 mt-1">Zaznacz, jeœli przejœcie ma byæ tymczasowo niewidoczne dla u¿ytkowników.</div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <label asp-for="PositionX" class="control-label">Pozycja X (%)</label>
                    <input asp-for="PositionX" class="form-control" id="posX" readonly style="background-color: #e9ecef;" />
                </div>
                <div class="col">
                    <label asp-for="PositionY" class="control-label">Pozycja Y (%)</label>
                    <input asp-for="PositionY" class="form-control" id="posY" readonly style="background-color: #e9ecef;" />
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-check-lg" aria-hidden="true"></i> Utwórz strza³kê
                </button>
            </div>
        </form>
        <div class="mt-3">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> Wróæ do listy przejœæ
            </a>
        </div>
    </div>

    <!-- Prawa kolumna: Podgl¹d i Klikanie -->
    <div class="col-md-8">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-cursor" aria-hidden="true"></i> 4. Kliknij na zdjêciu, aby ustawiæ strza³kê
            </div>
            <div class="card-body p-0 bg-dark">
                <div id="imageContainer" style="position: relative; width: 100%; padding-bottom: 50%; cursor: crosshair; overflow: hidden;">
                    <img id="previewImage" src="" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none;" alt="Podgl¹d lokalizacji Ÿród³owej" />

                    <div id="marker" style="position: absolute; width: 30px; height: 30px; background: rgba(255,0,0,0.7); border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none; box-shadow: 0 0 10px black;"></div>
                    
                    <p id="noImageMsg" class="text-white-50 position-absolute top-50 start-50 translate-middle m-0">Wybierz lokacjê "Sk¹d", aby za³adowaæ podgl¹d.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var imageMap = @Html.Raw(ViewBag.ImageMap ?? "{}");

        var sourceSelect = document.getElementById("sourceSelect");
        var previewImage = document.getElementById("previewImage");
        var noImageMsg = document.getElementById("noImageMsg");
        var marker = document.getElementById("marker");
        var imageContainer = document.getElementById("imageContainer");
        var inpX = document.getElementById("posX");
        var inpY = document.getElementById("posY");

        sourceSelect.addEventListener("change", function() {
            var id = this.value;
            var fileName = imageMap[id];

            if (fileName) {
                previewImage.src = "/images/" + fileName;
                previewImage.style.display = "block";
                noImageMsg.style.display = "none";
            } else {
                previewImage.style.display = "none";
                noImageMsg.style.display = "block";
                marker.style.display = "none";
            }
        });

        imageContainer.addEventListener("click", function(e) {
            if (previewImage.style.display === "none") return;

            var rect = imageContainer.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;

            var percentX = Math.round((x / rect.width) * 100);
            var percentY = Math.round((y / rect.height) * 100);

            percentX = Math.max(0, Math.min(100, percentX));
            percentY = Math.max(0, Math.min(100, percentY));

            inpX.value = percentX;
            inpY.value = percentY;

            marker.style.left = percentX + "%";
            marker.style.top = percentY + "%";
            marker.style.display = "block";
        });
    </script>
}