@model WirtualnaUczelnia.Models.Transition

@{
    ViewData["Title"] = "Dodaj przejœcie";
}

<!-- Style dla custom dropdown z podgl¹dem -->
<style>
    .custom-dropdown {
        position: relative;
    }
    .custom-dropdown-toggle {
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .custom-dropdown-menu {
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
    }
    .custom-dropdown-item {
        cursor: pointer;
        padding: 8px 12px;
        transition: background-color 0.15s;
    }
    .custom-dropdown-item:hover {
        background-color: #e9ecef;
    }
    .custom-dropdown-item.selected {
        background-color: #0d6efd;
        color: white;
    }
    
    /* Tooltip z podgl¹dem obrazka */
    .hover-preview {
        position: fixed;
        z-index: 9999;
        pointer-events: none;
        background: white;
        border: 3px solid #0d6efd;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        padding: 5px;
        display: none;
        max-width: 320px;
    }
    .hover-preview img {
        width: 300px;
        height: 170px;
        object-fit: cover;
        border-radius: 4px;
    }
    .hover-preview .preview-label {
        text-align: center;
        font-weight: bold;
        font-size: 12px;
        margin-top: 5px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<h1 tabindex="0">Dodaj nowe przejœcie (Strza³kê)</h1>
<hr />

<!-- Tooltip podgl¹du obrazka -->
<div id="hoverPreview" class="hover-preview">
    <img id="hoverPreviewImg" src="" alt="Podgl¹d lokacji" />
    <div id="hoverPreviewLabel" class="preview-label"></div>
</div>

<div class="row">
    <!-- Lewa kolumna: Formularz -->
    <div class="col-md-4">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <div class="form-group mb-3">
                <label class="control-label fw-bold">1. Sk¹d wychodzimy?</label>
                <input type="hidden" asp-for="SourceLocationId" id="sourceSelectHidden" />
                <div class="dropdown custom-dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle custom-dropdown-toggle" type="button" id="sourceDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="sourceDropdownText">-- Wybierz --</span>
                    </button>
                    <ul class="dropdown-menu custom-dropdown-menu" id="sourceDropdownMenu" aria-labelledby="sourceDropdownBtn">
                        <li><div class="custom-dropdown-item" data-value="" data-image="">-- Wybierz --</div></li>
                        @foreach (var item in (SelectList)ViewBag.SourceLocationId)
                        {
                            <li><div class="custom-dropdown-item" data-value="@item.Value" data-image="@(((Dictionary<string, string>)ViewBag.ImageMapDict).GetValueOrDefault(item.Value, ""))">@item.Text</div></li>
                        }
                    </ul>
                </div>
            </div>

            <div class="form-group mb-3">
                <label class="control-label fw-bold">2. Dok¹d idziemy?</label>
                <input type="hidden" asp-for="TargetLocationId" id="targetSelectHidden" />
                <div class="dropdown custom-dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle custom-dropdown-toggle" type="button" id="targetDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="targetDropdownText">-- Wybierz --</span>
                    </button>
                    <ul class="dropdown-menu custom-dropdown-menu" id="targetDropdownMenu" aria-labelledby="targetDropdownBtn">
                        <li><div class="custom-dropdown-item" data-value="" data-image="">-- Wybierz --</div></li>
                        @foreach (var item in (SelectList)ViewBag.TargetLocationId)
                        {
                            <li><div class="custom-dropdown-item" data-value="@item.Value" data-image="@(((Dictionary<string, string>)ViewBag.ImageMapDict).GetValueOrDefault(item.Value, ""))">@item.Text</div></li>
                        }
                    </ul>
                </div>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Direction" class="control-label fw-bold">3. Rodzaj strza³ki</label>
                <select asp-for="Direction" class="form-select" asp-items="Html.GetEnumSelectList<WirtualnaUczelnia.Models.Direction>()"></select>
            </div>

            <!-- Koszt przejœcia -->
            <div class="form-group mb-3">
                <label asp-for="Cost" class="control-label fw-bold">
                    <i class="bi bi-speedometer2 text-info" aria-hidden="true"></i> Koszt przejœcia
                </label>
                <input asp-for="Cost" type="number" class="form-control" min="1" max="1000" value="10" aria-describedby="costHelp" />
                <small id="costHelp" class="form-text text-muted">
                    Umowna wartoœæ (np. w sekundach lub metrach). Im wy¿szy koszt, tym mniej preferowane przejœcie.
                    <br><strong>Przyk³ady:</strong> Krótki korytarz = 5, Normalny = 10, D³ugi korytarz = 20, Schody = 15-25, Winda = 30
                </small>
                <span asp-validation-for="Cost" class="text-danger" role="alert"></span>
            </div>

            <!-- Checkbox dostêpnoœci dla wózków -->
            <div class="form-check mb-3 p-3 bg-light border rounded">
                <input class="form-check-input ms-1" asp-for="IsWheelchairAccessible" id="accessibilityCheck" checked style="transform: scale(1.3);" />
                <label class="form-check-label fw-bold ms-2" for="accessibilityCheck">
                    <i class="bi bi-person-wheelchair text-primary" aria-hidden="true"></i> Dostêpne dla wózków
                </label>
                <div class="form-text ms-1 mt-1">Zostaw zaznaczone, jeœli jest p³asko lub jest winda. Odznacz, jeœli to schody.</div>
            </div>

            <!-- Checkbox ukrycia -->
            <div class="form-check mb-3 p-3 bg-light border rounded">
                <input class="form-check-input ms-1" asp-for="IsHidden" id="isHiddenCheck" style="transform: scale(1.3);" />
                <label class="form-check-label fw-bold ms-2" for="isHiddenCheck">
                    <i class="bi bi-eye-slash text-secondary" aria-hidden="true"></i> Ukryte
                </label>
                <div class="form-text ms-1 mt-1">Zaznacz, jeœli przejœcie ma byæ tymczasowo niewidoczne dla u¿ytkowników.</div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <label asp-for="PositionX" class="control-label">Pozycja X (%)</label>
                    <input asp-for="PositionX" class="form-control" id="posX" readonly style="background-color: #e9ecef;" />
                </div>
                <div class="col">
                    <label asp-for="PositionY" class="control-label">Pozycja Y (%)</label>
                    <input asp-for="PositionY" class="form-control" id="posY" readonly style="background-color: #e9ecef;" />
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-check-lg" aria-hidden="true"></i> Utwórz strza³kê
                </button>
            </div>
        </form>
        <div class="mt-3">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> Wróæ do listy przejœæ
            </a>
        </div>
    </div>

    <!-- Prawa kolumna: Podgl¹dy lokacji -->
    <div class="col-md-8">
        <div class="row">
            <!-- Podgl¹d lokacji Ÿród³owej (SK¥D) -->
            <div class="col-12 mb-3">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-cursor" aria-hidden="true"></i> 4. Lokacja Ÿród³owa (SK¥D) - Kliknij, aby ustawiæ strza³kê
                    </div>
                    <div class="card-body p-0 bg-dark">
                        <div id="imageContainer" style="position: relative; width: 100%; padding-bottom: 50%; cursor: crosshair; overflow: hidden;">
                            <img id="previewImage" src="" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none;" alt="Podgl¹d lokalizacji Ÿród³owej" />

                            <div id="marker" style="position: absolute; width: 30px; height: 30px; background: rgba(255,0,0,0.7); border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none; box-shadow: 0 0 10px black;"></div>
                            
                            <p id="noImageMsg" class="text-white-50 position-absolute top-50 start-50 translate-middle m-0">Wybierz lokacjê "Sk¹d", aby za³adowaæ podgl¹d.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Podgl¹d lokacji docelowej (DOK¥D) -->
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-geo-alt" aria-hidden="true"></i> Lokacja docelowa (DOK¥D) - Podgl¹d
                    </div>
                    <div class="card-body p-0 bg-dark">
                        <div id="targetImageContainer" style="position: relative; width: 100%; padding-bottom: 50%; overflow: hidden;">
                            <img id="targetPreviewImage" src="" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none;" alt="Podgl¹d lokalizacji docelowej" />
                            
                            <p id="targetNoImageMsg" class="text-white-50 position-absolute top-50 start-50 translate-middle m-0">Wybierz lokacjê "Dok¹d", aby za³adowaæ podgl¹d.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var imageMap = @Html.Raw(ViewBag.ImageMap ?? "{}");

        // Elementy podgl¹du g³ównego
        var previewImage = document.getElementById("previewImage");
        var targetPreviewImage = document.getElementById("targetPreviewImage");
        var noImageMsg = document.getElementById("noImageMsg");
        var targetNoImageMsg = document.getElementById("targetNoImageMsg");
        var marker = document.getElementById("marker");
        var imageContainer = document.getElementById("imageContainer");
        var inpX = document.getElementById("posX");
        var inpY = document.getElementById("posY");

        // Elementy custom dropdown
        var sourceHidden = document.getElementById("sourceSelectHidden");
        var targetHidden = document.getElementById("targetSelectHidden");
        var sourceDropdownText = document.getElementById("sourceDropdownText");
        var targetDropdownText = document.getElementById("targetDropdownText");

        // Elementy hover preview
        var hoverPreview = document.getElementById("hoverPreview");
        var hoverPreviewImg = document.getElementById("hoverPreviewImg");
        var hoverPreviewLabel = document.getElementById("hoverPreviewLabel");

        // Funkcja aktualizacji podgl¹du Ÿród³owego
        function updateSourcePreview() {
            var id = sourceHidden.value;
            var fileName = imageMap[id];

            if (fileName) {
                previewImage.src = "/images/" + fileName;
                previewImage.style.display = "block";
                noImageMsg.style.display = "none";
            } else {
                previewImage.style.display = "none";
                noImageMsg.style.display = "block";
                marker.style.display = "none";
            }
        }

        // Funkcja aktualizacji podgl¹du docelowego
        function updateTargetPreview() {
            var id = targetHidden.value;
            var fileName = imageMap[id];

            if (fileName) {
                targetPreviewImage.src = "/images/" + fileName;
                targetPreviewImage.style.display = "block";
                targetNoImageMsg.style.display = "none";
            } else {
                targetPreviewImage.style.display = "none";
                targetNoImageMsg.style.display = "block";
            }
        }

        // Obs³uga custom dropdown - Ÿród³o
        document.querySelectorAll('#sourceDropdownMenu .custom-dropdown-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var value = this.getAttribute('data-value');
                var text = this.textContent;
                sourceHidden.value = value;
                sourceDropdownText.textContent = text;
                
                // Usuñ zaznaczenie ze wszystkich i dodaj do wybranego
                document.querySelectorAll('#sourceDropdownMenu .custom-dropdown-item').forEach(function(i) {
                    i.classList.remove('selected');
                });
                this.classList.add('selected');
                
                updateSourcePreview();
            });

            // Hover preview
            item.addEventListener('mouseenter', function(e) {
                var imageFile = this.getAttribute('data-image');
                var text = this.textContent;
                if (imageFile && imageFile !== '') {
                    hoverPreviewImg.src = "/images/" + imageFile;
                    hoverPreviewLabel.textContent = text;
                    hoverPreview.style.display = "block";
                    positionPreview(e);
                }
            });

            item.addEventListener('mousemove', function(e) {
                positionPreview(e);
            });

            item.addEventListener('mouseleave', function() {
                hoverPreview.style.display = "none";
            });
        });

        // Obs³uga custom dropdown - cel
        document.querySelectorAll('#targetDropdownMenu .custom-dropdown-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var value = this.getAttribute('data-value');
                var text = this.textContent;
                targetHidden.value = value;
                targetDropdownText.textContent = text;
                
                // Usuñ zaznaczenie ze wszystkich i dodaj do wybranego
                document.querySelectorAll('#targetDropdownMenu .custom-dropdown-item').forEach(function(i) {
                    i.classList.remove('selected');
                });
                this.classList.add('selected');
                
                updateTargetPreview();
            });

            // Hover preview
            item.addEventListener('mouseenter', function(e) {
                var imageFile = this.getAttribute('data-image');
                var text = this.textContent;
                if (imageFile && imageFile !== '') {
                    hoverPreviewImg.src = "/images/" + imageFile;
                    hoverPreviewLabel.textContent = text;
                    hoverPreview.style.display = "block";
                    positionPreview(e);
                }
            });

            item.addEventListener('mousemove', function(e) {
                positionPreview(e);
            });

            item.addEventListener('mouseleave', function() {
                hoverPreview.style.display = "none";
            });
        });

        // Funkcja pozycjonowania podgl¹du
        function positionPreview(e) {
            var x = e.clientX + 20;
            var y = e.clientY - 100;

            // Upewnij siê, ¿e preview nie wychodzi poza ekran
            var previewWidth = 320;
            var previewHeight = 220;
            
            if (x + previewWidth > window.innerWidth) {
                x = e.clientX - previewWidth - 20;
            }
            if (y < 10) {
                y = 10;
            }
            if (y + previewHeight > window.innerHeight) {
                y = window.innerHeight - previewHeight - 10;
            }

            hoverPreview.style.left = x + "px";
            hoverPreview.style.top = y + "px";
        }

        // Ukryj preview gdy dropdown siê zamyka
        document.querySelectorAll('.dropdown').forEach(function(dropdown) {
            dropdown.addEventListener('hidden.bs.dropdown', function() {
                hoverPreview.style.display = "none";
            });
        });

        // Klikanie na obrazku Ÿród³owym
        imageContainer.addEventListener("click", function(e) {
            if (previewImage.style.display === "none") return;

            var rect = imageContainer.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;

            var percentX = Math.round((x / rect.width) * 100);
            var percentY = Math.round((y / rect.height) * 100);

            percentX = Math.max(0, Math.min(100, percentX));
            percentY = Math.max(0, Math.min(100, percentY));

            inpX.value = percentX;
            inpY.value = percentY;

            marker.style.left = percentX + "%";
            marker.style.top = percentY + "%";
            marker.style.display = "block";
        });
    </script>
}