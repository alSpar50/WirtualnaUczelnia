@model WirtualnaUczelnia.Models.Transition

@{
    ViewData["Title"] = "Edytuj przejœcie";
}

<h1>Edytuj przejœcie</h1>
<hr />

<div class="row">
    <!-- Lewa kolumna: Formularz -->
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />

            <div class="form-group mb-3">
                <label class="control-label fw-bold">1. Sk¹d wychodzimy?</label>
                <select asp-for="SourceLocationId" class="form-select" asp-items="ViewBag.SourceLocationId" id="sourceSelect"></select>
            </div>

            <div class="form-group mb-3">
                <label class="control-label fw-bold">2. Dok¹d idziemy?</label>
                <select asp-for="TargetLocationId" class="form-select" asp-items="ViewBag.TargetLocationId"></select>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Direction" class="control-label fw-bold">3. Rodzaj strza³ki</label>
                <select asp-for="Direction" class="form-select" asp-items="Html.GetEnumSelectList<WirtualnaUczelnia.Models.Direction>()"></select>
            </div>

            <div class="form-check mb-3 p-3 bg-light border rounded">
                <input class="form-check-input ms-1" asp-for="IsWheelchairAccessible" id="accessibilityCheck" style="transform: scale(1.3);" />
                <label class="form-check-label fw-bold ms-2" for="accessibilityCheck">
                    <i class="bi bi-person-wheelchair text-primary"></i> Dostêpne dla wózków
                </label>
                <div class="form-text ms-1 mt-1">Odznacz, jeœli to schody.</div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <label asp-for="PositionX" class="control-label">Pozycja X (%)</label>
                    <input asp-for="PositionX" class="form-control" id="posX" readonly style="background-color: #e9ecef;" />
                </div>
                <div class="col">
                    <label asp-for="PositionY" class="control-label">Pozycja Y (%)</label>
                    <input asp-for="PositionY" class="form-control" id="posY" readonly style="background-color: #e9ecef;" />
                </div>
            </div>

            <div class="form-group">
                <input type="submit" value="Zapisz zmiany" class="btn btn-primary w-100" />
            </div>
        </form>
        <div class="mt-3">
            <a asp-action="Index">Wróæ do listy</a>
        </div>
    </div>

    <!-- Prawa kolumna: Podgl¹d -->
    <div class="col-md-8">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                4. Kliknij, aby zmieniæ pozycjê strza³ki
            </div>
            <div class="card-body p-0 bg-dark text-center d-flex align-items-center justify-content-center" style="min-height: 500px; overflow: hidden;">

                <div id="imageContainer" style="position: relative; display: inline-block; cursor: crosshair;">
                    <img id="previewImage" src="" style="max-width: 100%; display: none;" />

                    <!-- Marker -->
                    <div id="marker" style="position: absolute; width: 30px; height: 30px; background: rgba(255,165,0,0.8); border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none; box-shadow: 0 0 10px black;"></div>
                </div>

                <p id="noImageMsg" class="text-white-50">Brak podgl¹du.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var imageMap = @Html.Raw(ViewBag.ImageMap ?? "{}");

        var sourceSelect = document.getElementById("sourceSelect");
        var previewImage = document.getElementById("previewImage");
        var noImageMsg = document.getElementById("noImageMsg");
        var marker = document.getElementById("marker");
        var imageContainer = document.getElementById("imageContainer");
        var inpX = document.getElementById("posX");
        var inpY = document.getElementById("posY");

        function loadImageAndMarker() {
            var id = sourceSelect.value;
            var fileName = imageMap[id];

            if (fileName) {
                previewImage.src = "/images/" + fileName;
                previewImage.style.display = "block";
                noImageMsg.style.display = "none";
                marker.style.display = "block";

                // Ustaw marker na podstawie istniej¹cych wartoœci X i Y
                var x = inpX.value;
                var y = inpY.value;
                marker.style.left = x + "%";
                marker.style.top = y + "%";

            } else {
                previewImage.style.display = "none";
                noImageMsg.style.display = "block";
                marker.style.display = "none";
            }
        }

        // 1. £adujemy obrazek od razu po wejœciu na stronê (Edit mode)
        window.addEventListener('load', loadImageAndMarker);

        // 2. Obs³uga zmiany lokacji
        sourceSelect.addEventListener("change", loadImageAndMarker);

        // 3. Klikanie (aktualizacja pozycji)
        imageContainer.addEventListener("click", function(e) {
            if (previewImage.style.display === "none") return;

            var rect = this.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;

            var percentX = Math.round((x / rect.width) * 100);
            var percentY = Math.round((y / rect.height) * 100);

            percentX = Math.max(0, Math.min(100, percentX));
            percentY = Math.max(0, Math.min(100, percentY));

            inpX.value = percentX;
            inpY.value = percentY;

            marker.style.left = percentX + "%";
            marker.style.top = percentY + "%";
        });
    </script>
}